# Using Apollo with Roblox

This guide explains how to use Apollo-compiled code in Roblox projects, following a structure similar to roblox-ts.

## Project Structure

### 1. Basic Structure

Organize your project like this:
```
project/
├── src/
│   ├── shared/          # Code shared between client and server
│   │   ├── types.rkt    # Type definitions
│   │   └── utils.rkt    # Utility functions
│   ├── server/          # Server-side code
│   │   └── main.rkt     # Main server logic
│   └── client/          # Client-side code
│       └── main.rkt     # Main client logic
├── out/                 # Compiled output
│   ├── shared/          # Compiled shared code
│   ├── server/          # Compiled server code
│   └── client/          # Compiled client code
└── apollo.config.json   # Compiler configuration
```

### 2. Rojo Integration

Use Rojo to sync your compiled code to Roblox Studio:

```json
{
  "name": "MyGame",
  "tree": {
    "$className": "DataModel",
    "ReplicatedStorage": {
      "$className": "ReplicatedStorage",
      "Shared": {
        "$path": "out/shared"
      }
    },
    "ServerScriptService": {
      "$className": "ServerScriptService",
      "Server": {
        "$path": "out/server"
      }
    },
    "StarterPlayer": {
      "$className": "StarterPlayer",
      "StarterPlayerScripts": {
        "$className": "StarterPlayerScripts",
        "Client": {
          "$path": "out/client"
        }
      }
    }
  }
}
```

## Compilation

### 1. Basic Compilation

Compile your Racket code for Roblox:
```bash
apollo compile src/shared/types.rkt -o out/shared/types.luau --target roblox
```

### 2. Project Compilation

Compile an entire project:
```bash
apollo compile src/ --rojo --target roblox
```

## Type Safety

### 1. Type Definitions

Define Roblox types in Racket:
```racket
#lang typed/racket

(require typed/racket/class)

(define-type Player
  (Class
   [name (-> String)]
   [userId (-> Integer)]
   [character (-> (Option Character))]
   [getAttribute (-> Symbol Any)]
   [setAttribute (-> Symbol Any Void)]))

(define-type Character
  (Class
   [humanoid (-> Humanoid)]
   [primaryPart (-> (Option BasePart))]
   [getAttribute (-> Symbol Any)]
   [setAttribute (-> Symbol Any Void)]))
```

### 2. Declaration Files

Apollo generates `.d.luau` declaration files alongside your compiled Luau code. These files provide type information for your modules:

```luau
-- Type declarations for types.luau
-- Generated by Apollo Racket-to-Luau Compiler

export type Player = {
    name: () -> string,
    userId: () -> number,
    character: () -> Character?,
    getAttribute: (symbol: string) -> any,
    setAttribute: (symbol: string, value: any) -> nil
}

export type Character = {
    humanoid: () -> Humanoid,
    primaryPart: () -> BasePart?,
    getAttribute: (symbol: string) -> any,
    setAttribute: (symbol: string, value: any) -> nil
}

export type Module = {
    Player: Player,
    Character: Character
}

return Module
```

Use declaration files in your Luau code:
```luau
local types = require(script.Parent.types) :: types.Module

local player: types.Player = -- ...
local character: types.Character = -- ...
```

### 3. Type Checking

Enable strict type checking:
```json
{
  "roblox": {
    "typeChecking": {
      "level": "strict",
      "warnings": true,
      "declarationFiles": true
    }
  }
}
```

## Best Practices

### 1. Module Organization

Organize your code into modules:
```racket
#lang racket

(module types racket
  (provide (all-defined-out))
  
  (struct player ([name : String]
                  [userId : Integer]
                  [character : (Option Character)])))

(module utils racket
  (require (submod ".." types))
  (provide (all-defined-out))
  
  (define (get-player-name [p : player]) : String
    (player-name p)))
```

### 2. Event Handling

Handle Roblox events safely:
```racket
#lang typed/racket

(require typed/racket/class)

(: on-player-joined (-> Player Void))
(define (on-player-joined player)
  (printf "Player ~a joined the game\n" (send player name))
  (setup-player player))

(: setup-player (-> Player Void))
(define (setup-player player)
  (send player setAttribute 'health 100)
  (send player setAttribute 'coins 0))
```

### 3. Remote Events

Handle remote events with type safety:
```racket
#lang typed/racket

(require typed/racket/class)

(define-type RemoteEvent
  (Class
   [onServerEvent (-> (-> Player Any Void) Void)]
   [onClientEvent (-> (-> Any Void) Void)]
   [fireServer (-> Any Void)]
   [fireClient (-> Player Any Void)]))

(: handle-remote-event (-> RemoteEvent Void))
(define (handle-remote-event event)
  (send event onServerEvent
        (lambda ([player : Player] [data : Any])
          (printf "Received data from ~a: ~a\n" 
                  (send player name)
                  data))))
```

## Common Patterns

### 1. Game State Management

```racket
#lang typed/racket

(struct game-state
  ([players : (HashTable Integer Player)]
   [objects : (Vectorof GameObject)]
   [score : Integer]))

(: update-game-state (-> game-state Void))
(define (update-game-state state)
  (for ([(id player) (in-hash (game-state-players state))])
    (update-player player)))
```

### 2. UI Components

```racket
#lang typed/racket

(require typed/racket/class)

(define-type UIComponent
  (Class
   [show (-> Void)]
   [hide (-> Void)]
   [update (-> Any Void)]))

(: create-button (-> String (-> Void) UIComponent))
(define (create-button text callback)
  (new (class object%
         (super-new)
         (define/public (show) (void))
         (define/public (hide) (void))
         (define/public (update data) (void)))))
```

## See Also

* [Roblox Configuration Reference](../reference/roblox-config.md)
* [Type System](../explanation/type-system.md)
* [Compilation Process](../explanation/compilation.md) 